import numpy as np
from cms.config import PhysicsConfig

class CondensationEvaporation:
    """
    Модуль, реализующий процессы конденсации водяного пара в облачные капли и их испарение.
    
    Для обеспечения численной стабильности используется схема релаксации к насыщению,
    которая плавно корректирует содержание водяного пара и облачной воды, стремясь
    к состоянию равновесия (насыщения).
    """
    def __init__(self, config: PhysicsConfig):
        """
        Инициализирует модуль с физическими константами.
        
        Args:
            config: Датакласс PhysicsConfig с константами.
        """
        self.config = config
        self.Rv = 461.5  # Индивидуальная газовая постоянная для водяного пара, Дж/(кг*К)
        self.D_v = 2.26e-5  # Коэффициент диффузии водяного пара в воздухе, м^2/с

    def compute_saturation_vapor_pressure(self, T: np.ndarray) -> np.ndarray:
        """
        Рассчитывает давление насыщенного пара над плоской поверхностью воды.
        Используется эмпирическая формула Тетенса.
        
        Args:
            T: Температура воздуха в Кельвинах.

        Returns:
            Давление насыщенного пара в Паскалях.
        """
        # Преобразование в градусы Цельсия для формулы
        # Добавлена отсечка для предотвращения численного переполнения в np.exp
        T_c = np.clip(T - 273.15, -80.0, 80.0)
        return 611.2 * np.exp(17.67 * T_c / (T_c + 243.5))

    def compute_condensation_rate(self, qv: np.ndarray, qc: np.ndarray, T: np.ndarray, p: np.ndarray, rho: np.ndarray) -> tuple[np.ndarray, np.ndarray]:
        """
        Рассчитывает скорость конденсации/испарения.
        
        Вместо прямого вычисления по сложным формулам (которые численно нестабильны),
        этот метод использует "схему релаксации к насыщению". Логика следующая:
        1. Вычисляется равновесная массовая доля пара `q_sat`, при которой воздух насыщен.
        2. Находится разница `delta_q` между текущей `qv` и равновесной `q_sat`.
        3. Скорость изменения `dqv_dt` определяется так, чтобы эта разница `delta_q`
           устранялась за определенное характерное время `tau`.
        4. Накладываются ограничения, чтобы не испарить больше воды, чем есть, и не
           сконденсировать больше пара, чем есть.
           
        Этот подход является численно более устойчивым для жестких уравнений фазовых переходов.

        Args:
            qv: Массовая доля водяного пара (кг/кг).
            qc: Массовая доля облачной воды (кг/кг).
            T: Абсолютная температура (K).
            p: Давление (Па).
            rho: Плотность воздуха (кг/м^3).

        Returns:
            Кортеж с тенденциями для облачной воды и водяного пара (dqc_dt, dqv_dt).
        """
        epsilon = self.config.rd / self.Rv  # Отношение газовых постоянных (≈0.622)
        
        # 1. Рассчитать равновесную (насыщающую) массовую долю водяного пара (q_sat)
        e_sat = self.compute_saturation_vapor_pressure(T)
        q_sat = epsilon * e_sat / np.maximum(p - e_sat, 1e-5) # Защита от деления на ноль

        # 2. Определить отклонение от насыщения (насколько воздух пересыщен или недосыщен)
        delta_q = qv - q_sat
        
        # 3. Применить схему релаксации
        # Положительное delta_q -> пересыщение (должна происходить конденсация, qv уменьшается)
        # Отрицательное delta_q -> недосыщение (должно происходить испарение, qv увеличивается)
        tau = 10.0  # Время релаксации к равновесию [с]. Более высокое значение = более плавный процесс.
        
        # Скорость изменения [кг/кг / с]. Знак минус, т.к. при пересыщении (delta_q > 0) пар должен убывать.
        dqv_dt = -delta_q / tau
        
        # 4. Ограничить скорость, чтобы избежать нефизичных отрицательных значений
        # Испарение (dqv_dt > 0) не может быть быстрее, чем позволяет наличие облачной воды qc.
        dqv_dt = np.where(dqv_dt > 0, np.minimum(dqv_dt, qc / tau), dqv_dt)
        # Конденсация (dqv_dt < 0) не может быть быстрее, чем позволяет наличие водяного пара qv.
        dqv_dt = np.where(dqv_dt < 0, np.maximum(dqv_dt, -qv / tau), dqv_dt)
        
        # Изменение массы облачной воды противоположно изменению массы пара
        dqc_dt = -dqv_dt
        
        return dqc_dt, dqv_dt
