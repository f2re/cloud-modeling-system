import numpy as np

def compute_reagent_emission(grid, x_source, y_source, h_source, Q,
                             sigma_x=500.0, sigma_y=500.0, sigma_z=100.0):
    """
    Вычисляет скорость выброса реагента от источника, параметризованного
    как трехмерное гауссово распределение.

    ВНИМАНИЕ: Эта реализация является ПРЕДПОЛОЖЕНИЕМ, основанным на
    стандартных моделях Гауссова шлейфа. Она ДОЛЖНА БЫТЬ ПРОВЕРЕНА
    и адаптирована в соответствии с точными уравнениями 5.21-5.24 из монографии.

    Args:
        grid (GridConfig): Конфигурация сетки, содержащая массивы координат X, Y, Z.
        x_source (float): X-координата центра источника (м).
        y_source (float): Y-координата центра источника (м).
        h_source (float): Z-координата (высота) центра источника (м).
        Q (float): Интенсивность выброса (масса или число частиц в секунду).
        sigma_x (float): Стандартное отклонение по оси X (м).
        sigma_y (float): Стандартное отклонение по оси Y (м).
        sigma_z (float): Стандартное отклонение по оси Z (м).

    Returns:
        np.ndarray: 3D-массив скорости выброса реагента в каждой ячейке сетки.
    """
    X, Y, Z = grid.X, grid.Y, grid.Z

    # Вычисляем гауссово распределение
    exponent = (
        -((X - x_source)**2) / (2 * sigma_x**2)
        -((Y - y_source)**2) / (2 * sigma_y**2)
        -((Z - h_source)**2) / (2 * sigma_z**2)
    )
    
    # Нормируем, чтобы интеграл по всему объему был равен Q
    # Объем ячейки
    dv = grid.dx * grid.dy * grid.dz
    
    # Вычисляем ненормированный источник
    source_term_unnormalized = np.exp(exponent)
    
    # Нормируем так, чтобы сумма по всем ячейкам, умноженная на объем ячейки, была равна Q*dt
    # В данном случае, мы возвращаем интенсивность (Q/с), поэтому нормируем на Q.
    total_sum = np.sum(source_term_unnormalized) * dv
    
    if total_sum > 1e-12:
        source_term = Q * source_term_unnormalized / total_sum
    else:
        # Если источник находится далеко за пределами сетки, сумма может быть нулевой
        source_term = np.zeros_like(X)

    return source_term
